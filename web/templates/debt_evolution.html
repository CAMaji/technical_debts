{% extends "_base.html" %}

{% block content %}

{% if repository %}
	<div class="container my-4">
		<!-- Header -->
		<div class="text-center mb-4">
			<h1>Technical Debt Evolution</h1>
			<p class="lead">
				Showing debt evolution for 
				<strong>{{ repository.owner }}</strong>/<strong>{{ repository.name }}</strong>
			</p>
			<div class="mt-3">
				<a href="{{ url_for('dashboard', owner=repository.owner, name=repository.name) }}" 
				   class="btn btn-outline-secondary">
					<i class="bi bi-arrow-left"></i> Back to Dashboard
				</a>
			</div>
		</div>

		<!-- Filters Section -->
		<div class="card mb-4 shadow-sm">
			<div class="card-body">
				<form method="GET" class="row g-3 align-items-end">
					<div class="col-md-3">
						<label for="branch" class="form-label">Branch</label>
						<select class="form-select" name="branch" id="branch">
							{% for branch in branches %}
								<option value="{{ branch.name }}" {% if selected_branch and branch.id == selected_branch.id %}selected{% endif %}>
									{{ branch.name }}
								</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-3">
						<label for="start_date" class="form-label">Start Date</label>
						<input type="text" class="form-control" name="start_date" id="start_date" 
							   value="{{ start_date }}" placeholder="dd/mm/yyyy hh:mm">
					</div>
					<div class="col-md-3">
						<label for="end_date" class="form-label">End Date</label>
						<input type="text" class="form-control" name="end_date" id="end_date" 
							   value="{{ end_date }}" placeholder="dd/mm/yyyy hh:mm">
					</div>
					<div class="col-md-3">
						<button type="submit" class="btn btn-primary w-100">Update Chart</button>
					</div>
				</form>
			</div>
		</div>

		<!-- Chart Section -->
		<div class="card shadow-sm mb-4">
			<div class="card-body">
				<h3 class="card-title fw-bold mb-4">Technical Debt Evolution Over Time</h3>
				
				{% if debt_data %}
					<div id="debt-evolution-chart" style="width:100%;height:600px;"></div>
				{% else %}
					<div class="text-center py-5">
						<p class="text-muted">No data available for the selected period.</p>
						<p class="text-muted">Try adjusting the date range or ensure the repository has been analyzed.</p>
					</div>
				{% endif %}
			</div>
		</div>

		<!-- Complexity Chart Section -->
		<div class="card shadow-sm">
			<div class="card-body">
				<h3 class="card-title fw-bold mb-4">Complexity Evolution Over Time</h3>
				
				{% if debt_data %}
					<div id="complexity-evolution-chart" style="width:100%;height:600px;"></div>
				{% else %}
					<div class="text-center py-5">
						<p class="text-muted">No complexity data available for the selected period.</p>
						<p class="text-muted">Try adjusting the date range or ensure the repository has been analyzed.</p>
					</div>
				{% endif %}
			</div>
		</div>

		<!-- Summary Statistics -->
		{% if debt_data %}
		<div class="card mt-4 shadow-sm">
			<div class="card-body">
				<h4 class="card-title">Summary Statistics</h4>
				<div class="row">
					<div class="col-md-3">
						<div class="text-center">
							<h5 class="text-primary" id="total-commits">{{ debt_data|length }}</h5>
							<small class="text-muted">Total Commits</small>
						</div>
					</div>
					<div class="col-md-3">
						<div class="text-center">
							<h5 class="text-warning" id="linked-bugs-total">-</h5>
							<small class="text-muted">Linked Bugs</small>
						</div>
					</div>
					<div class="col-md-3">
						<div class="text-center">
							<h5 class="text-danger" id="max-debt">-</h5>
							<small class="text-muted">Peak Debt</small>
						</div>
					</div>
					<div class="col-md-3">
						<div class="text-center">
							<h5 class="text-success" id="current-debt">-</h5>
							<small class="text-muted">Current Debt</small>
						</div>
					</div>
					<div class="col-md-3">
						<div class="text-center">
							<h5 id="debt-trend">-</h5>
							<small class="text-muted">Trend</small>
						</div>
					</div>
				</div>
			</div>
		</div>
		{% endif %}
	</div>

{% elif error %}
	<div class="container my-4">
		<div class="text-center mb-4">
			<h1>Technical Debt Evolution</h1>
			<div class="alert alert-danger">
				<h4>Error</h4>
				<p>{{ error }}</p>
			</div>
		</div>
	</div>

{% else %}
	<div class="container my-4">
		<div class="text-center mb-4">
			<h1>Technical Debt Evolution</h1>
			<p class="lead">
				Repository not found or not yet analyzed.
			</p>
		</div>
	</div>
{% endif %}

<!-- Pass data to JavaScript -->
{% if debt_data %}
<script>
	const debtData = {{ debt_data | tojson }};
	const repositoryName = "{{ repository.owner }}/{{ repository.name }}";
</script>
<script src="{{ url_for('static', filename='js/debt_evolution.js') }}"></script>
{% endif %}

{% endblock %}